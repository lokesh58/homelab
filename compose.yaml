services:
  #################################################################################
  # Cloudflare
  #################################################################################
  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    env_file:
      - .env.cloudflared
    networks:
      - authentik-ingress
      - open-webui-ingress
      - penpot-ingress
      - code-runner-ingress

  #################################################################################
  # Traefik
  #################################################################################
  traefik:
    image: traefik:v3.6
    restart: unless-stopped
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --entrypoints.websecure.http.tls.certresolver=${CERT_RESOLVER}
      - --entrypoints.websecure.http.tls.domains[0].main=internal.${DOMAIN}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.internal.${DOMAIN}
      - --certificatesresolvers.staging-resolver.acme.dnschallenge=true
      - --certificatesresolvers.staging-resolver.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.staging-resolver.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.staging-resolver.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.staging-resolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
      - --certificatesresolvers.prod-resolver.acme.dnschallenge=true
      - --certificatesresolvers.prod-resolver.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.prod-resolver.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.prod-resolver.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.prod-resolver.acme.caserver=https://acme-v02.api.letsencrypt.org/directory
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --api.dashboard=true
      - --api.insecure=false
      - --log.level=INFO
    env_file:
      - .env.traefik
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates-data:/letsencrypt
    networks:
      - authentik-ingress
      - open-webui-ingress
      - penpot-ingress
      - code-runner-ingress
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.internal.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.middlewares=authentik-auth@docker"

  #################################################################################
  # Authentik
  #################################################################################
  authentik-server:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_VERSION}
    restart: unless-stopped
    command: server
    depends_on:
      authentik-postgresql:
        condition: service_healthy
    env_file:
      - .env.authentik.common
      - .env.authentik.server
    volumes:
      - authentik-media-data:/media
      - authentik-custom-templates-data:/templates
    networks:
      - authentik-net
      - authentik-ingress
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authentik.rule=Host(`auth.${DOMAIN}`)"
      - "traefik.http.routers.authentik.entrypoints=websecure"
      - "traefik.http.routers.authentik.tls.certresolver=${CERT_RESOLVER}"
      - "traefik.http.routers.authentik.tls.domains[0].main=auth.${DOMAIN}"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      - "traefik.http.middlewares.authentik-auth.forwardauth.address=http://authentik-server:9000/outpost.goauthentik.io/auth/internal"
      - "traefik.http.middlewares.authentik-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authentik-auth.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"

  authentik-worker:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_VERSION}
    restart: unless-stopped
    user: root
    command: worker
    depends_on:
      authentik-postgresql:
        condition: service_healthy
    env_file:
      - .env.authentik.common
      - .env.authentik.server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - authentik-media-data:/media
      - authentik-custom-templates-data:/templates
      - authentik-certs-data:/certs
      - ./authentik/blueprints:/blueprints
    networks:
      - authentik-net

  authentik-postgresql:
    image: postgres:16-alpine
    restart: unless-stopped
    env_file:
      - .env.authentik.common
      - .env.authentik.db
    volumes:
      - authentik-db-data:/var/lib/postgresql/data
    networks:
      - authentik-net
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 20s
      test:
        - CMD-SHELL
        - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}
      timeout: 5s

  #################################################################################
  # Ollama
  #################################################################################
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - ollama-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  #################################################################################
  # Open WebUI
  #################################################################################
  open-webui:
    image: ghcr.io/open-webui/open-webui:cuda
    restart: unless-stopped
    env_file:
      - .env.open_webui
    volumes:
      - open-webui-data:/app/backend/data
    networks:
      - ollama-net
      - open-webui-ingress
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.open-webui.rule=Host(`openwebui.${DOMAIN}`)"
      - "traefik.http.routers.open-webui.entrypoints=websecure"
      - "traefik.http.routers.open-webui.tls.certresolver=${CERT_RESOLVER}"
      - "traefik.http.routers.open-webui.tls.domains[0].main=openwebui.${DOMAIN}"
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  #################################################################################
  # Penpot
  #################################################################################
  penpot-frontend:
    image: penpotapp/frontend:${PENPOT_VERSION}
    restart: unless-stopped
    depends_on:
      - penpot-backend
      - penpot-exporter
    env_file:
      - .env.penpot.flags
      - .env.penpot.body_size
    volumes:
      - penpot-assets-data:/opt/data/assets
    networks:
      - penpot-net
      - penpot-ingress
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.penpot.rule=Host(`penpot.${DOMAIN}`)"
      - "traefik.http.routers.penpot.entrypoints=websecure"
      - "traefik.http.routers.penpot.tls.certresolver=${CERT_RESOLVER}"
      - "traefik.http.routers.penpot.tls.domains[0].main=penpot.${DOMAIN}"
      - "traefik.http.services.penpot.loadbalancer.server.port=8080"

  penpot-backend:
    image: penpotapp/backend:${PENPOT_VERSION}
    restart: unless-stopped
    depends_on:
      penpot-postgres:
        condition: service_healthy
      penpot-valkey:
        condition: service_healthy
    env_file:
      - .env.penpot.common
      - .env.penpot.flags
      - .env.penpot.uri
      - .env.penpot.body_size
      - .env.penpot.secret_key
      - .env.penpot.backend
    volumes:
      - penpot-assets-data:/opt/data/assets
    networks:
      - penpot-net

  penpot-exporter:
    image: penpotapp/exporter:${PENPOT_VERSION}
    restart: unless-stopped
    depends_on:
      penpot-valkey:
        condition: service_healthy
    env_file:
      - .env.penpot.secret_key
      - .env.penpot.exporter
    networks:
      - penpot-net

  penpot-postgres:
    image: postgres:15
    restart: unless-stopped
    stop_signal: SIGINT
    env_file:
      - .env.penpot.common
      - .env.penpot.postgres
    volumes:
      - penpot-db-data:/var/lib/postgresql/data
    networks:
      - penpot-net
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}
      interval: 2s
      timeout: 10s
      retries: 5
      start_period: 2s

  penpot-valkey:
    image: valkey/valkey:8.1
    restart: unless-stopped
    env_file:
      - .env.penpot.valkey
    networks:
      - penpot-net
    healthcheck:
      test:
        - CMD-SHELL
        - valkey-cli ping | grep PONG
      interval: 1s
      timeout: 3s
      retries: 5
      start_period: 3s

  #################################################################################
  # Code Runner
  #################################################################################
  code-runner:
    image: huakesh/code-runner:latest
    restart: unless-stopped
    env_file:
      - .env.code_runner
    networks:
      - code-runner-net
      - code-runner-ingress
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.code-runner.rule=Host(`code-runner.${DOMAIN}`)"
      - "traefik.http.routers.code-runner.entrypoints=websecure"
      - "traefik.http.routers.code-runner.tls.certresolver=${CERT_RESOLVER}"
      - "traefik.http.routers.code-runner.tls.domains[0].main=code-runner.${DOMAIN}"
      - "traefik.http.services.code-runner.loadbalancer.server.port=8080"

  #################################################################################
  # Lichobi
  #################################################################################
  lichobi:
    image: huakesh/lichobi:latest
    restart: unless-stopped
    env_file:
      - .env.lichobi
    networks:
      - code-runner-net

volumes:
  traefik-certificates-data:
  authentik-media-data:
  authentik-custom-templates-data:
  authentik-certs-data:
  authentik-db-data:
  ollama-data:
  open-webui-data:
  penpot-assets-data:
  penpot-db-data:

networks:
  authentik-net:
  authentik-ingress:
  ollama-net:
  open-webui-ingress:
  penpot-net:
  penpot-ingress:
  code-runner-net:
  code-runner-ingress:
