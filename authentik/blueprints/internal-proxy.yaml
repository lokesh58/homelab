version: 1
metadata:
  name: Internal Global Proxy Setup
  labels:
    type: internal-proxy

entries:
  # Define the Proxy Provider
  - model: authentik_providers_proxy.proxyprovider
    id: provider-internal
    identifiers:
      name: Internal Global Proxy
    attrs:
      name: Internal Global Proxy
      # Use !Env for dynamic domain
      external_host: !Format ["https://auth.%s", [!Env "DOMAIN"]]
      mode: forward_domain
      # Restricted cookie domain for internal apps only
      cookie_domain: !Format [".internal.%s", [!Env "DOMAIN"]]
      # Use the default authorization flow (Implicit Consent)
      authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
      # Use the default authentication flow
      authentication_flow: !Find [authentik_flows.flow, [slug, "default-authentication-flow"]]
      access_token_validity: hours=24

  # Define the Application
  - model: authentik_core.application
    id: app-internal
    identifiers:
      slug: internal
    attrs:
      name: Internal Gateway
      slug: internal
      provider: !KeyOf provider-internal
      policy_engine_mode: any
      group: Internal

  # Ensure the 'internal' group exists
  - model: authentik_core.group
    id: group-internal
    identifiers:
      name: internal
    attrs:
      name: internal
      is_superuser: false

  # Bind the 'internal' group directly to the Application
  # This grants access to members of this group.
  - model: authentik_policies.policybinding
    identifiers:
      target: !KeyOf app-internal
      group: !KeyOf group-internal
      order: 0
    attrs:
      enabled: true

  # Link the Provider to the Embedded Outpost
  - model: authentik_outposts.outpost
    identifiers:
      name: "authentik Embedded Outpost"
    attrs:
      providers:
        - !KeyOf provider-internal
